<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ğŸ” éº¦å½“åŠ³ MCP å®¢æˆ·ç«¯</title>
    <style>
      :root {
        --mcd-yellow: #ffc72c;
        --mcd-red: #da291c;
        --bg-dark: #1a1a2e;
        --bg-card: #16213e;
        --bg-item: #1e2a4a;
        --text: #eaeaea;
        --text-muted: #888;
        --success: #4ade80;
        --warning: #fbbf24;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        background: linear-gradient(135deg, var(--bg-dark) 0%, #0f0f23 100%);
        color: var(--text);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 900px;
        margin: 0 auto;
      }
      header {
        text-align: center;
        margin-bottom: 30px;
      }

      h1 {
        font-size: 2.5rem;
        background: linear-gradient(90deg, var(--mcd-yellow), var(--mcd-red));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .subtitle {
        color: var(--text-muted);
        margin-top: 8px;
      }

      .card {
        background: var(--bg-card);
        border-radius: 16px;
        padding: 24px;
        margin-bottom: 20px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      }

      .card h2 {
        color: var(--mcd-yellow);
        margin-bottom: 16px;
        font-size: 1.2rem;
      }
      .input-group {
        margin-bottom: 16px;
      }
      label {
        display: block;
        margin-bottom: 8px;
        color: var(--text-muted);
        font-size: 0.9rem;
      }

      input,
      select {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #2a2a4a;
        border-radius: 8px;
        background: #0d1025;
        color: var(--text);
        font-size: 1rem;
        transition: border-color 0.2s;
      }

      input:focus,
      select:focus {
        outline: none;
        border-color: var(--mcd-yellow);
      }

      .tools-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 12px;
        margin-bottom: 20px;
      }

      .tool-btn {
        padding: 16px 12px;
        border: none;
        border-radius: 12px;
        background: linear-gradient(135deg, #2a2a4a 0%, #1a1a3a 100%);
        color: var(--text);
        cursor: pointer;
        transition: all 0.2s;
        text-align: center;
      }

      .tool-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 20px rgba(255, 199, 44, 0.2);
      }
      .tool-btn.active {
        background: linear-gradient(135deg, var(--mcd-red) 0%, #b22318 100%);
      }
      .tool-btn .icon {
        font-size: 1.5rem;
        display: block;
        margin-bottom: 8px;
      }
      .tool-btn .name {
        font-weight: 600;
        font-size: 0.8rem;
      }

      .run-btn {
        width: 100%;
        padding: 16px;
        border: none;
        border-radius: 12px;
        background: linear-gradient(135deg, var(--mcd-yellow) 0%, #e5a800 100%);
        color: #000;
        font-size: 1.1rem;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.2s;
      }

      .run-btn:hover {
        transform: scale(1.02);
        box-shadow: 0 4px 20px rgba(255, 199, 44, 0.4);
      }
      .run-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      .result {
        background: #0d1025;
        border-radius: 12px;
        padding: 20px;
        max-height: 700px;
        overflow: auto;
      }

      .result.error {
        border-left: 4px solid var(--mcd-red);
      }
      .result.success {
        border-left: 4px solid var(--success);
      }

      .loader {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #333;
        border-top-color: var(--mcd-yellow);
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .token-hint {
        font-size: 0.8rem;
        color: var(--text-muted);
        margin-top: 8px;
      }
      .token-hint a {
        color: var(--mcd-yellow);
        text-decoration: none;
      }

      .status {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 12px 16px;
        border-radius: 8px;
        font-size: 0.9rem;
      }
      .status.connected {
        background: rgba(74, 222, 128, 0.1);
        color: var(--success);
      }
      .status.disconnected {
        background: rgba(218, 41, 28, 0.1);
        color: var(--mcd-red);
      }

      /* ========== æ—¶é—´å¡ç‰‡ ========== */
      .time-card {
        background: linear-gradient(135deg, #1e3a5f 0%, #0d1f3c 100%);
        border-radius: 16px;
        padding: 24px;
        text-align: center;
      }
      .time-card .time {
        font-size: 3rem;
        font-weight: 700;
        color: var(--mcd-yellow);
      }
      .time-card .date {
        font-size: 1.2rem;
        color: var(--text);
        margin-top: 8px;
      }
      .time-card .week {
        color: var(--text-muted);
        margin-top: 4px;
      }
      .time-card .timezone {
        font-size: 0.8rem;
        color: var(--text-muted);
        margin-top: 12px;
      }

      /* ========== æ—¥å†æ ·å¼ ========== */
      .calendar-container {
        background: #fff;
        border-radius: 16px;
        padding: 20px;
        color: #333;
      }

      .calendar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 2px solid #eee;
      }

      .calendar-header h3 {
        font-size: 1.4rem;
        color: #333;
        font-weight: 700;
      }

      .calendar-nav {
        display: flex;
        gap: 8px;
      }

      .calendar-nav button {
        background: #f5f5f5;
        border: none;
        padding: 8px 16px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1rem;
        transition: all 0.2s;
      }

      .calendar-nav button:hover {
        background: var(--mcd-yellow);
      }

      .calendar-weekdays {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 4px;
        margin-bottom: 8px;
      }

      .calendar-weekdays span {
        text-align: center;
        font-weight: 600;
        color: #888;
        font-size: 0.85rem;
        padding: 8px;
      }

      .calendar-days {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 4px;
      }

      .calendar-day {
        aspect-ratio: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        cursor: pointer;
        border-radius: 8px;
        transition: all 0.2s;
        font-weight: 500;
        font-size: 1rem;
      }

      .calendar-day:hover {
        background: #f5f5f5;
      }

      .calendar-day.other-month {
        color: #ccc;
      }

      .calendar-day.today {
        font-weight: 700;
        color: var(--mcd-red);
      }

      .calendar-day.selected {
        background: var(--mcd-yellow);
        color: #000;
      }

      .calendar-day .day-num {
        position: relative;
        z-index: 2;
      }

      .calendar-day svg {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 100%;
        height: 100%;
        z-index: 1;
        pointer-events: none;
      }

      /* æ´»åŠ¨è¯¦æƒ…å¼¹çª— */
      .activity-popup {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        padding: 20px;
      }

      .activity-popup.show {
        display: flex;
      }

      .popup-content {
        background: var(--bg-card);
        border-radius: 16px;
        max-width: 600px;
        width: 100%;
        max-height: 80vh;
        overflow: auto;
        color: var(--text);
      }

      .popup-header {
        padding: 20px;
        border-bottom: 1px solid #2a2a4a;
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: sticky;
        top: 0;
        background: var(--bg-card);
      }

      .popup-header h3 {
        color: var(--mcd-yellow);
        font-size: 1.2rem;
      }

      .popup-close {
        background: none;
        border: none;
        color: var(--text);
        font-size: 1.5rem;
        cursor: pointer;
        padding: 4px 12px;
        border-radius: 8px;
      }

      .popup-close:hover {
        background: rgba(255, 255, 255, 0.1);
      }

      .popup-body {
        padding: 20px;
      }

      .activity-item {
        background: var(--bg-item);
        border-radius: 12px;
        margin-bottom: 12px;
        overflow: hidden;
      }

      .activity-item .title {
        padding: 12px 16px;
        background: rgba(255, 199, 44, 0.1);
        font-weight: 600;
        font-size: 0.95rem;
      }

      .activity-item .body {
        padding: 16px;
        display: flex;
        gap: 16px;
      }

      .activity-item .body img {
        width: 100px;
        height: 100px;
        object-fit: cover;
        border-radius: 8px;
        flex-shrink: 0;
      }

      .activity-item .body .content {
        flex: 1;
        font-size: 0.85rem;
        line-height: 1.6;
        color: var(--text-muted);
      }

      /* ========== ä¼˜æƒ åˆ¸æ ·å¼ ========== */
      .coupons-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
        gap: 16px;
      }

      .coupon-card {
        background: var(--bg-item);
        border-radius: 12px;
        overflow: hidden;
        transition: transform 0.2s;
      }

      .coupon-card:hover {
        transform: translateY(-4px);
      }

      .coupon-card img {
        width: 100%;
        height: 120px;
        object-fit: cover;
        background: #2a2a4a;
      }

      .coupon-card .info {
        padding: 12px;
      }
      .coupon-card .coupon-title {
        font-weight: 600;
        font-size: 0.95rem;
        margin-bottom: 8px;
        color: var(--text);
      }
      .coupon-card .price {
        font-size: 1.3rem;
        font-weight: 700;
        color: var(--mcd-red);
      }
      .coupon-card .price::before {
        content: "Â¥";
        font-size: 0.9rem;
      }
      .coupon-card .validity {
        font-size: 0.75rem;
        color: var(--text-muted);
        margin-top: 6px;
      }
      .coupon-card .tags {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
        margin-top: 8px;
      }

      .tag {
        font-size: 0.7rem;
        padding: 2px 8px;
        border-radius: 4px;
        background: rgba(255, 199, 44, 0.15);
        color: var(--mcd-yellow);
      }
      .tag.status-claimed {
        background: rgba(74, 222, 128, 0.15);
        color: var(--success);
      }
      .tag.status-available {
        background: rgba(251, 191, 36, 0.15);
        color: var(--warning);
      }
      .tag.status-unavailable {
        background: rgba(100, 100, 100, 0.2);
        color: #888;
      }

      /* é¢†åˆ¸ç»“æœ */
      .bind-result {
        text-align: center;
        padding: 20px;
      }
      .bind-result .icon {
        font-size: 4rem;
      }
      .bind-result .bind-title {
        font-size: 1.5rem;
        font-weight: 700;
        margin: 16px 0 8px;
      }
      .bind-stats {
        display: flex;
        justify-content: center;
        gap: 40px;
        margin: 24px 0;
      }
      .bind-stat {
        text-align: center;
      }
      .bind-stat .num {
        font-size: 2.5rem;
        font-weight: 700;
      }
      .bind-stat .num.success {
        color: var(--success);
      }
      .bind-stat .num.fail {
        color: var(--mcd-red);
      }
      .bind-stat .label {
        font-size: 0.85rem;
        color: var(--text-muted);
      }

      .stats-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 16px;
        background: rgba(255, 199, 44, 0.1);
        border-radius: 8px;
        margin-bottom: 16px;
      }
      .stats-bar .count {
        font-weight: 700;
        color: var(--mcd-yellow);
      }

      /* æ—¥å†å›¾ä¾‹ */
      .calendar-legend {
        display: flex;
        gap: 16px;
        padding: 12px 16px;
        background: #f9f9f9;
        border-radius: 8px;
        margin-top: 16px;
        font-size: 0.85rem;
        color: #666;
      }

      .legend-item {
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .legend-circle {
        width: 20px;
        height: 20px;
      }

      /* ========== ç”˜ç‰¹å›¾æ ·å¼ ========== */
      .gantt-container {
        background: var(--bg-item);
        border-radius: 12px;
        padding: 20px;
        overflow-x: auto;
      }

      .gantt-header {
        display: flex;
        border-bottom: 2px solid #2a2a4a;
        padding-bottom: 8px;
        margin-bottom: 12px;
        min-width: 800px;
      }

      .gantt-label-col {
        width: 200px;
        flex-shrink: 0;
        font-weight: 600;
        color: var(--mcd-yellow);
        font-size: 0.9rem;
      }

      .gantt-timeline {
        flex: 1;
        display: flex;
        position: relative;
      }

      .gantt-day {
        flex: 1;
        text-align: center;
        font-size: 0.75rem;
        color: var(--text-muted);
        min-width: 30px;
      }

      .gantt-day.today {
        color: var(--mcd-red);
        font-weight: 700;
      }

      .gantt-day.weekend {
        color: #666;
      }

      .gantt-row {
        display: flex;
        align-items: center;
        min-height: 50px;
        border-bottom: 1px solid #1a1a3a;
        min-width: 800px;
        cursor: pointer;
        transition: background 0.2s;
      }

      .gantt-row:hover {
        background: rgba(255, 199, 44, 0.05);
      }

      .gantt-row:last-child {
        border-bottom: none;
      }

      .gantt-item-label {
        width: 200px;
        flex-shrink: 0;
        padding-right: 16px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .gantt-item-label img {
        width: 36px;
        height: 36px;
        border-radius: 6px;
        object-fit: cover;
      }

      .gantt-item-label .name {
        font-size: 0.85rem;
        color: var(--text);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 140px;
      }

      .gantt-item-timeline {
        flex: 1;
        position: relative;
        height: 28px;
      }

      .gantt-bar {
        position: absolute;
        height: 24px;
        border-radius: 6px;
        top: 2px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.7rem;
        font-weight: 600;
        color: #fff;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        transition: all 0.2s;
        overflow: hidden;
        white-space: nowrap;
      }

      .gantt-bar:hover {
        transform: scaleY(1.15);
        z-index: 10;
      }

      .gantt-bar.active {
        background: linear-gradient(135deg, var(--mcd-red) 0%, #ff6b6b 100%);
      }

      .gantt-bar.upcoming {
        background: linear-gradient(135deg, var(--mcd-yellow) 0%, #ffe066 100%);
        color: #333;
      }

      .gantt-bar.expired {
        background: linear-gradient(135deg, #444 0%, #666 100%);
        opacity: 0.6;
      }

      .gantt-today-line {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 2px;
        background: var(--mcd-red);
        z-index: 5;
      }

      /* ä¼˜æƒ åˆ¸è¯¦æƒ…å¼¹çª— */
      .coupon-detail {
        display: flex;
        gap: 20px;
        padding: 20px;
      }

      .coupon-detail img {
        width: 150px;
        height: 150px;
        object-fit: cover;
        border-radius: 12px;
      }

      .coupon-detail .info {
        flex: 1;
      }

      .coupon-detail .info h4 {
        font-size: 1.2rem;
        color: var(--mcd-yellow);
        margin-bottom: 12px;
      }

      .coupon-detail .info .price {
        font-size: 2rem;
        font-weight: 700;
        color: var(--mcd-red);
        margin-bottom: 8px;
      }

      .coupon-detail .info .price::before {
        content: "Â¥";
        font-size: 1.2rem;
      }

      .coupon-detail .info .meta {
        font-size: 0.9rem;
        color: var(--text-muted);
        line-height: 1.8;
      }

      .coupon-detail .info .tags {
        margin-top: 12px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>ğŸ” éº¦å½“åŠ³ MCP å®¢æˆ·ç«¯</h1>
        <p class="subtitle">æŸ¥è¯¢ä¼˜æƒ åˆ¸ã€æ´»åŠ¨æ—¥å†ã€ä¸€é”®é¢†åˆ¸</p>
      </header>

      <div class="card">
        <h2>ğŸ”‘ é…ç½® Token</h2>
        <div class="input-group">
          <label>MCP Token</label>
          <input type="password" id="token" placeholder="è¾“å…¥ä½ çš„ MCP Token" />
          <p class="token-hint">
            æ²¡æœ‰ Tokenï¼Ÿ<a href="https://open.mcd.cn/mcp/doc" target="_blank"
              >ç‚¹å‡»ç”³è¯· â†’</a
            >
          </p>
        </div>
        <div id="status" class="status disconnected">
          <span>âšª</span> æœªè¿æ¥
        </div>
      </div>

      <div class="card">
        <h2>ğŸ”§ é€‰æ‹©å·¥å…·</h2>
        <div class="tools-grid">
          <button class="tool-btn" data-tool="now-time-info">
            <span class="icon">â°</span><span class="name">å½“å‰æ—¶é—´</span>
          </button>
          <button class="tool-btn" data-tool="campaign-calender">
            <span class="icon">ğŸ“…</span><span class="name">æ´»åŠ¨æ—¥å†</span>
          </button>
          <button class="tool-btn" data-tool="available-coupons">
            <span class="icon">ğŸ«</span><span class="name">å¯é¢†ä¼˜æƒ åˆ¸</span>
          </button>
          <button class="tool-btn" data-tool="my-coupons">
            <span class="icon">ğŸŸï¸</span><span class="name">æˆ‘çš„ä¼˜æƒ åˆ¸</span>
          </button>
          <button class="tool-btn" data-tool="auto-bind-coupons">
            <span class="icon">ğŸ</span><span class="name">ä¸€é”®é¢†åˆ¸</span>
          </button>
        </div>
        <button class="run-btn" id="runBtn" disabled>â–¶ æ‰§è¡Œ</button>
      </div>

      <div class="card">
        <h2>ğŸ“¤ ç»“æœ</h2>
        <div class="result" id="result">ç­‰å¾…æ‰§è¡Œ...</div>
      </div>
    </div>

    <!-- æ´»åŠ¨è¯¦æƒ…å¼¹çª— -->
    <div class="activity-popup" id="activityPopup">
      <div class="popup-content">
        <div class="popup-header">
          <h3 id="popupTitle">æ´»åŠ¨è¯¦æƒ…</h3>
          <button class="popup-close" onclick="closePopup()">Ã—</button>
        </div>
        <div class="popup-body" id="popupBody"></div>
      </div>
    </div>

    <script>
      const MCP_URL = "/mcp";
      let selectedTool = null;
      let sessionId = null;
      let calendarData = {}; // å­˜å‚¨æ—¥å†æ•°æ®

      // å·¥å…·æŒ‰é’®
      document.querySelectorAll(".tool-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          document
            .querySelectorAll(".tool-btn")
            .forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");
          selectedTool = btn.dataset.tool;
          document.getElementById("runBtn").disabled =
            !document.getElementById("token").value;
        });
      });

      // Token
      document.getElementById("token").addEventListener("input", (e) => {
        const hasToken = e.target.value.trim().length > 0;
        document.getElementById("runBtn").disabled = !hasToken || !selectedTool;
        if (hasToken) localStorage.setItem("mcd_token", e.target.value);
      });

      const savedToken = localStorage.getItem("mcd_token");
      if (savedToken) document.getElementById("token").value = savedToken;

      // æ‰§è¡Œ
      document.getElementById("runBtn").addEventListener("click", async () => {
        const token = document.getElementById("token").value.trim();
        if (!token || !selectedTool) return;

        const resultEl = document.getElementById("result");
        const statusEl = document.getElementById("status");
        const runBtn = document.getElementById("runBtn");

        resultEl.className = "result";
        resultEl.innerHTML = '<span class="loader"></span> æ‰§è¡Œä¸­...';
        runBtn.disabled = true;

        try {
          if (!sessionId) {
            const initResp = await callMCP(token, "initialize", {
              protocolVersion: "2024-11-05",
              capabilities: { tools: {} },
              clientInfo: { name: "mcd-web-client", version: "1.0.0" },
            });
            if (initResp.error) throw new Error(initResp.error.message);
            statusEl.className = "status connected";
            statusEl.innerHTML = "<span>ğŸŸ¢</span> å·²è¿æ¥";
          }

          const resp = await callMCP(token, "tools/call", {
            name: selectedTool,
            arguments: {},
          });
          if (resp.error) throw new Error(resp.error.message);

          resultEl.className = "result success";
          resultEl.innerHTML = formatResult(selectedTool, resp.result);
        } catch (err) {
          resultEl.className = "result error";
          resultEl.innerHTML = "âŒ é”™è¯¯: " + err.message;
          statusEl.className = "status disconnected";
          statusEl.innerHTML = "<span>ğŸ”´</span> è¿æ¥å¤±è´¥";
          sessionId = null;
        } finally {
          runBtn.disabled = false;
        }
      });

      async function callMCP(token, method, params) {
        const headers = {
          Authorization: `Bearer ${token}`,
          "Content-Type": "application/json",
        };
        if (sessionId) headers["Mcp-Session-Id"] = sessionId;
        const resp = await fetch(MCP_URL, {
          method: "POST",
          headers,
          body: JSON.stringify({ jsonrpc: "2.0", id: 1, method, params }),
        });
        const newSessionId = resp.headers.get("Mcp-Session-Id");
        if (newSessionId) sessionId = newSessionId;
        return resp.json();
      }

      // ========== ç»“æœæ ¼å¼åŒ– ==========
      function formatResult(tool, result) {
        const text = result?.content?.[0]?.text || "";
        const structured = result?.structuredContent;

        switch (tool) {
          case "now-time-info":
            return formatTimeInfo(structured || parseTimeFromText(text));
          case "campaign-calender":
            return formatCalendar(text);
          case "available-coupons":
            return formatAvailableCoupons(text);
          case "my-coupons":
            return formatMyCoupons(text);
          case "auto-bind-coupons":
            return formatBindResult(text);
          default:
            return `<pre>${text}</pre>`;
        }
      }

      // æ—¶é—´
      function formatTimeInfo(data) {
        if (!data?.data) return "<p>æ— æ³•è§£ææ—¶é—´æ•°æ®</p>";
        const d = data.data;
        const weekMap = {
          MONDAY: "æ˜ŸæœŸä¸€",
          TUESDAY: "æ˜ŸæœŸäºŒ",
          WEDNESDAY: "æ˜ŸæœŸä¸‰",
          THURSDAY: "æ˜ŸæœŸå››",
          FRIDAY: "æ˜ŸæœŸäº”",
          SATURDAY: "æ˜ŸæœŸå…­",
          SUNDAY: "æ˜ŸæœŸæ—¥",
        };
        return `<div class="time-card"><div class="time">${d.formatted?.split(" ")[1] || ""}</div><div class="date">${d.date || ""}</div><div class="week">${weekMap[d.dayOfWeek] || d.dayOfWeek}</div><div class="timezone">æ—¶åŒº: ${d.timezone} | UTC: ${d.utc}</div></div>`;
      }

      function parseTimeFromText(text) {
        const match = text.match(/"data":\s*(\{[^}]+\})/s);
        if (match) {
          try {
            return { data: JSON.parse(match[1].replace(/\n/g, "")) };
          } catch {}
        }
        return null;
      }

      // ========== æ—¥å† ==========
      function formatCalendar(text) {
        // è§£ææ‰€æœ‰æ´»åŠ¨
        calendarData = parseCalendarData(text);

        const now = new Date();
        const year = now.getFullYear();
        const month = now.getMonth();

        return renderCalendar(year, month);
      }

      function parseCalendarData(text) {
        const data = {};
        const dateRegex = /####?\s*(?:(\d+)å¹´)?(\d+)æœˆ(\d+)æ—¥/g;
        let match;
        let sections = [];
        let lastIndex = 0;

        while ((match = dateRegex.exec(text)) !== null) {
          if (sections.length > 0) {
            sections[sections.length - 1].content = text.slice(
              lastIndex,
              match.index,
            );
          }
          sections.push({
            year: match[1] || new Date().getFullYear(),
            month: parseInt(match[2]),
            day: parseInt(match[3]),
            content: "",
          });
          lastIndex = match.index + match[0].length;
        }
        if (sections.length > 0) {
          sections[sections.length - 1].content = text.slice(lastIndex);
        }

        sections.forEach((s) => {
          const key = `${s.year}-${s.month}-${s.day}`;
          const activities = parseActivities(s.content);
          if (activities.length > 0) {
            data[key] = activities;
          }
        });

        return data;
      }

      function parseActivities(text) {
        const activities = [];
        const regex =
          /\*\*æ´»åŠ¨æ ‡é¢˜\*\*[ï¼š:]\s*(.+?)\\[\s\S]*?\*\*æ´»åŠ¨å†…å®¹ä»‹ç»\*\*[ï¼š:]\s*([\s\S]*?)(?:\*\*æ´»åŠ¨å›¾ç‰‡ä»‹ç»\*\*[\s\S]*?<img src="([^"]+)")?(?=\n-\s*\*\*æ´»åŠ¨æ ‡é¢˜|$)/g;
        let match;
        while ((match = regex.exec(text)) !== null) {
          activities.push({
            title: match[1].trim(),
            content: match[2].replace(/\\n/g, "\n").replace(/\\/g, "").trim(),
            img: match[3] || "",
          });
        }
        return activities;
      }

      function renderCalendar(year, month) {
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const startDay = firstDay.getDay();
        const daysInMonth = lastDay.getDate();
        const today = new Date();

        const monthNames = [
          "ä¸€æœˆ",
          "äºŒæœˆ",
          "ä¸‰æœˆ",
          "å››æœˆ",
          "äº”æœˆ",
          "å…­æœˆ",
          "ä¸ƒæœˆ",
          "å…«æœˆ",
          "ä¹æœˆ",
          "åæœˆ",
          "åä¸€æœˆ",
          "åäºŒæœˆ",
        ];

        let html = `
                <div class="calendar-container">
                    <div class="calendar-header">
                        <h3>${year}å¹´ ${monthNames[month]}</h3>
                        <div class="calendar-nav">
                            <button onclick="changeMonth(-1)">â—€</button>
                            <button onclick="changeMonth(1)">â–¶</button>
                        </div>
                    </div>
                    <div class="calendar-weekdays">
                        <span>æ—¥</span><span>ä¸€</span><span>äºŒ</span><span>ä¸‰</span><span>å››</span><span>äº”</span><span>å…­</span>
                    </div>
                    <div class="calendar-days">
            `;

        // ä¸Šæœˆå¡«å……
        const prevMonth = new Date(year, month, 0);
        for (let i = startDay - 1; i >= 0; i--) {
          const day = prevMonth.getDate() - i;
          html += `<div class="calendar-day other-month"><span class="day-num">${day}</span></div>`;
        }

        // æœ¬æœˆ
        for (let day = 1; day <= daysInMonth; day++) {
          const key = `${year}-${month + 1}-${day}`;
          const activities = calendarData[key] || [];
          const count = activities.length;
          const isToday =
            today.getFullYear() === year &&
            today.getMonth() === month &&
            today.getDate() === day;

          let circles = "";
          if (count > 0) {
            circles = generateCrayonCircles(count);
          }

          html += `
                    <div class="calendar-day ${isToday ? "today" : ""}" 
                         onclick="showDayActivities('${key}')" 
                         data-key="${key}"
                         title="${count > 0 ? count + " ä¸ªæ´»åŠ¨" : "æ— æ´»åŠ¨"}">
                        ${circles}
                        <span class="day-num">${day}</span>
                    </div>
                `;
        }

        // ä¸‹æœˆå¡«å……
        const remaining = 42 - (startDay + daysInMonth);
        for (let i = 1; i <= remaining && i <= 7; i++) {
          html += `<div class="calendar-day other-month"><span class="day-num">${i}</span></div>`;
        }

        html += `
                    </div>
                    <div class="calendar-legend">
                        <div class="legend-item">
                            <svg class="legend-circle" viewBox="0 0 40 40">${generateSingleCircle(0.6)}</svg>
                            <span>1-2 ä¸ªæ´»åŠ¨</span>
                        </div>
                        <div class="legend-item">
                            <svg class="legend-circle" viewBox="0 0 40 40">${generateSingleCircle(0.6)}${generateSingleCircle(0.5)}</svg>
                            <span>3-5 ä¸ªæ´»åŠ¨</span>
                        </div>
                        <div class="legend-item">
                            <svg class="legend-circle" viewBox="0 0 40 40">${generateSingleCircle(0.7)}${generateSingleCircle(0.6)}${generateSingleCircle(0.5)}</svg>
                            <span>6+ ä¸ªæ´»åŠ¨</span>
                        </div>
                    </div>
                </div>
            `;

        // ä¿å­˜å½“å‰å¹´æœˆ
        window.currentYear = year;
        window.currentMonth = month;

        return html;
      }

      // ç”Ÿæˆèœ¡ç¬”é£æ ¼åœ†åœˆ
      function generateCrayonCircles(count) {
        let circles = "";
        const numCircles = count <= 2 ? 1 : count <= 5 ? 2 : 3;

        for (let i = 0; i < numCircles; i++) {
          circles += `<svg viewBox="0 0 40 40">${generateSingleCircle(0.7 - i * 0.15)}</svg>`;
        }

        return circles;
      }

      function generateSingleCircle(opacity) {
        // éšæœºå‚æ•°ç”Ÿæˆæ‰‹ç»˜æ•ˆæœ
        const cx = 20 + (Math.random() - 0.5) * 4;
        const cy = 20 + (Math.random() - 0.5) * 4;
        const rx = 14 + Math.random() * 4;
        const ry = 13 + Math.random() * 4;
        const rotation = (Math.random() - 0.5) * 20;
        const strokeWidth = 2 + Math.random() * 1.5;

        // ç”Ÿæˆä¸è§„åˆ™è·¯å¾„
        const points = [];
        const segments = 12 + Math.floor(Math.random() * 6);

        for (let i = 0; i <= segments; i++) {
          const angle = (i / segments) * Math.PI * 2;
          const wobble = 0.85 + Math.random() * 0.3;
          const x = cx + Math.cos(angle) * rx * wobble;
          const y = cy + Math.sin(angle) * ry * wobble;
          points.push({ x, y });
        }

        // åˆ›å»ºæ‰‹ç»˜æ›²çº¿è·¯å¾„
        let path = `M ${points[0].x} ${points[0].y}`;
        for (let i = 1; i < points.length; i++) {
          const prev = points[i - 1];
          const curr = points[i];
          const cpx = (prev.x + curr.x) / 2 + (Math.random() - 0.5) * 3;
          const cpy = (prev.y + curr.y) / 2 + (Math.random() - 0.5) * 3;
          path += ` Q ${cpx} ${cpy} ${curr.x} ${curr.y}`;
        }

        return `
                <path 
                    d="${path}" 
                    fill="none" 
                    stroke="#DA291C" 
                    stroke-width="${strokeWidth}"
                    stroke-opacity="${opacity}"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    transform="rotate(${rotation} 20 20)"
                    style="filter: url(#crayon-texture)"
                />
                <defs>
                    <filter id="crayon-texture" x="-20%" y="-20%" width="140%" height="140%">
                        <feTurbulence type="fractalNoise" baseFrequency="0.5" numOctaves="3" result="noise"/>
                        <feDisplacementMap in="SourceGraphic" in2="noise" scale="1" xChannelSelector="R" yChannelSelector="G"/>
                    </filter>
                </defs>
            `;
      }

      // åˆ‡æ¢æœˆä»½
      window.changeMonth = function (delta) {
        let year = window.currentYear;
        let month = window.currentMonth + delta;

        if (month < 0) {
          month = 11;
          year--;
        }
        if (month > 11) {
          month = 0;
          year++;
        }

        document.getElementById("result").innerHTML = renderCalendar(
          year,
          month,
        );
      };

      // æ˜¾ç¤ºæŸå¤©æ´»åŠ¨
      window.showDayActivities = function (key) {
        const activities = calendarData[key];
        if (!activities || activities.length === 0) {
          return;
        }

        const [year, month, day] = key.split("-");
        document.getElementById("popupTitle").textContent =
          `${month}æœˆ${day}æ—¥ æ´»åŠ¨ (${activities.length})`;

        let html = "";
        activities.forEach((a) => {
          html += `
                    <div class="activity-item">
                        <div class="title">${a.title}</div>
                        <div class="body">
                            ${a.img ? `<img src="${a.img}" onerror="this.style.display='none'" alt="">` : ""}
                            <div class="content">${a.content.replace(/\n/g, "<br>")}</div>
                        </div>
                    </div>
                `;
        });

        document.getElementById("popupBody").innerHTML = html;
        document.getElementById("activityPopup").classList.add("show");
      };

      // å…³é—­å¼¹çª—
      window.closePopup = function () {
        document.getElementById("activityPopup").classList.remove("show");
      };

      // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
      document
        .getElementById("activityPopup")
        .addEventListener("click", (e) => {
          if (e.target.id === "activityPopup") closePopup();
        });

      // ========== ä¼˜æƒ åˆ¸ ==========
      function formatAvailableCoupons(text) {
        const coupons = parseMarkdownCoupons(text);
        if (!coupons.length) return "<p>æš‚æ— å¯é¢†å–çš„ä¼˜æƒ åˆ¸</p>";

        return `
                <div class="stats-bar"><span>å¯é¢†å–ä¼˜æƒ åˆ¸</span><span class="count">${coupons.length} å¼ </span></div>
                <div class="coupons-grid">
                    ${coupons
                      .map(
                        (c) => `
                        <div class="coupon-card">
                            <img src="${c.img}" onerror="this.style.display='none'" alt="${c.title}">
                            <div class="info">
                                <div class="coupon-title">${c.title}</div>
                                <div class="tags">
                                    <span class="tag ${c.status === "å·²é¢†å–" ? "status-claimed" : c.status === "å¯é¢†å–" ? "status-available" : "status-unavailable"}">${c.status}</span>
                                </div>
                            </div>
                        </div>
                    `,
                      )
                      .join("")}
                </div>
            `;
      }

      // å­˜å‚¨ä¼˜æƒ åˆ¸æ•°æ®ç”¨äºå¼¹çª—
      let myCouponsData = [];

      function formatMyCoupons(text) {
        const countMatch = text.match(/å…±\s*(\d+)\s*å¼ /);
        const count = countMatch ? countMatch[1] : "0";

        const coupons = [];
        // ä¿®å¤åçš„æ­£åˆ™: åŒ¹é… **ä¼˜æƒ **: Â¥æ•°å­— å’Œ **æœ‰æ•ˆæœŸ**: æ ¼å¼
        const regex =
          /##\s*(.+?)[\n\r][\s\S]*?\*\*ä¼˜æƒ \*\*:\s*Â¥?(\d+(?:\.\d+)?)[^\n]*[\s\S]*?\*\*æœ‰æ•ˆæœŸ\*\*:\s*([^\n]+)[\s\S]*?(?:\*\*æ ‡ç­¾\*\*:\s*([^\n]+))?[\s\S]*?<img src="([^"]+)"/g;
        let match;
        while ((match = regex.exec(text)) !== null) {
          coupons.push({
            title: match[1].trim(),
            price: match[2],
            validity: match[3].trim(),
            tags: match[4] ? match[4].split("ã€") : [],
            img: match[5],
          });
        }

        if (!coupons.length) {
          const simpleRegex = /##\s*(.+?)[\n\r][\s\S]*?<img src="([^"]+)"/g;
          while ((match = simpleRegex.exec(text)) !== null) {
            coupons.push({
              title: match[1].trim(),
              img: match[2],
              price: "",
              validity: "",
              tags: [],
            });
          }
        }

        myCouponsData = coupons;
        return renderCouponGantt(coupons, count);
      }

      function renderCouponGantt(coupons, count) {
        // ç¡®å®šæ—¶é—´èŒƒå›´ï¼šä»ä»Šå¤©å¾€å‰3å¤©åˆ°å¾€å30å¤©
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const startDate = new Date(today);
        startDate.setDate(startDate.getDate() - 3);
        const endDate = new Date(today);
        endDate.setDate(endDate.getDate() + 30);

        const totalDays = Math.ceil(
          (endDate - startDate) / (1000 * 60 * 60 * 24),
        );

        // ç”Ÿæˆæ—¥æœŸå¤´
        let headerDays = "";
        for (let i = 0; i < totalDays; i++) {
          const d = new Date(startDate);
          d.setDate(d.getDate() + i);
          const isToday = d.getTime() === today.getTime();
          const isWeekend = d.getDay() === 0 || d.getDay() === 6;
          const dayNum = d.getDate();
          const showMonth = dayNum === 1 || i === 0;
          headerDays += `<div class="gantt-day ${isToday ? "today" : ""} ${isWeekend ? "weekend" : ""}">${showMonth ? d.getMonth() + 1 + "/" : ""}${dayNum}</div>`;
        }

        // è®¡ç®—ä»Šå¤©çš„ä½ç½®
        const todayOffset = Math.ceil(
          (today - startDate) / (1000 * 60 * 60 * 24),
        );
        const todayPercent = (todayOffset / totalDays) * 100;

        // ç”Ÿæˆæ¯è¡Œ
        let rows = "";
        coupons.forEach((c, idx) => {
          // è§£ææœ‰æ•ˆæœŸ
          const dates = parseValidityDates(c.validity);
          if (!dates) {
            rows += `<div class="gantt-row" onclick="showCouponDetail(${idx})">
              <div class="gantt-item-label">
                <img src="${c.img}" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2236%22 height=%2236%22><rect fill=%22%232a2a4a%22 width=%2236%22 height=%2236%22/></svg>'">
                <span class="name" title="${c.title}">${c.title}</span>
              </div>
              <div class="gantt-item-timeline"><div class="gantt-bar expired" style="left:0;right:0">æ—¥æœŸæœªçŸ¥</div></div>
            </div>`;
            return;
          }

          const { start, end } = dates;

          // è®¡ç®—æ¡çš„ä½ç½®
          let barStart = Math.max(
            0,
            (start - startDate) / (1000 * 60 * 60 * 24),
          );
          let barEnd = Math.min(
            totalDays,
            (end - startDate) / (1000 * 60 * 60 * 24),
          );

          if (barEnd < 0 || barStart > totalDays) {
            // å®Œå…¨ä¸åœ¨èŒƒå›´å†…
            rows += `<div class="gantt-row" onclick="showCouponDetail(${idx})">
              <div class="gantt-item-label">
                <img src="${c.img}" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2236%22 height=%2236%22><rect fill=%22%232a2a4a%22 width=%2236%22 height=%2236%22/></svg>'">
                <span class="name" title="${c.title}">${c.title}</span>
              </div>
              <div class="gantt-item-timeline"><div class="gantt-bar expired" style="left:0;width:50px">å·²è¿‡æœŸ</div></div>
            </div>`;
            return;
          }

          const leftPercent = (barStart / totalDays) * 100;
          const widthPercent = ((barEnd - barStart) / totalDays) * 100;

          // åˆ¤æ–­çŠ¶æ€
          let status = "active";
          if (end < today) status = "expired";
          else if (start > today) status = "upcoming";

          const priceText = c.price ? `Â¥${c.price}` : "";

          rows += `<div class="gantt-row" onclick="showCouponDetail(${idx})">
            <div class="gantt-item-label">
              <img src="${c.img}" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2236%22 height=%2236%22><rect fill=%22%232a2a4a%22 width=%2236%22 height=%2236%22/></svg>'">
              <span class="name" title="${c.title}">${c.title}</span>
            </div>
            <div class="gantt-item-timeline">
              <div class="gantt-bar ${status}" style="left:${leftPercent}%;width:${Math.max(widthPercent, 3)}%">${priceText}</div>
            </div>
          </div>`;
        });

        return `
          <div class="stats-bar"><span>æˆ‘çš„ä¼˜æƒ åˆ¸</span><span class="count">${count} å¼ å¯ç”¨</span></div>
          <div class="gantt-container">
            <div class="gantt-header">
              <div class="gantt-label-col">ä¼˜æƒ åˆ¸</div>
              <div class="gantt-timeline">
                ${headerDays}
                <div class="gantt-today-line" style="left:${todayPercent}%"></div>
              </div>
            </div>
            ${rows}
            <div style="margin-top:16px;display:flex;gap:20px;font-size:0.8rem;color:var(--text-muted)">
              <span><span style="display:inline-block;width:12px;height:12px;background:linear-gradient(135deg,var(--mcd-red),#ff6b6b);border-radius:3px;margin-right:4px"></span>å¯ç”¨</span>
              <span><span style="display:inline-block;width:12px;height:12px;background:linear-gradient(135deg,var(--mcd-yellow),#ffe066);border-radius:3px;margin-right:4px"></span>å³å°†ç”Ÿæ•ˆ</span>
              <span><span style="display:inline-block;width:12px;height:12px;background:#555;border-radius:3px;margin-right:4px"></span>å·²è¿‡æœŸ</span>
              <span style="margin-left:auto">ğŸ”´ çº¢çº¿ = ä»Šå¤©</span>
            </div>
          </div>
        `;
      }

      function parseValidityDates(validity) {
        if (!validity) return null;
        // æ ¼å¼: 2026-01-15 00:00-2026-01-21 23:59 æˆ– 2026-01-19 10:45-2026-01-23 23:59 å‘¨ä¸€ã€äºŒ...
        const match = validity.match(
          /(\d{4}-\d{2}-\d{2})[^-]*-\s*(\d{4}-\d{2}-\d{2})/,
        );
        if (!match) return null;

        const start = new Date(match[1]);
        const end = new Date(match[2]);
        start.setHours(0, 0, 0, 0);
        end.setHours(23, 59, 59, 999);

        return { start, end };
      }

      window.showCouponDetail = function (idx) {
        const c = myCouponsData[idx];
        if (!c) return;

        document.getElementById("popupTitle").textContent = "ä¼˜æƒ åˆ¸è¯¦æƒ…";
        document.getElementById("popupBody").innerHTML = `
          <div class="coupon-detail">
            <img src="${c.img}" onerror="this.style.display='none'" alt="${c.title}">
            <div class="info">
              <h4>${c.title}</h4>
              ${c.price ? `<div class="price">${c.price}</div>` : ""}
              <div class="meta">
                <div>ğŸ“… æœ‰æ•ˆæœŸ: ${c.validity || "æœªçŸ¥"}</div>
              </div>
              ${c.tags.length ? `<div class="tags">${c.tags.map((t) => `<span class="tag">${t}</span>`).join("")}</div>` : ""}
            </div>
          </div>
        `;
        document.getElementById("activityPopup").classList.add("show");
      };

      function formatBindResult(text) {
        const totalMatch = text.match(/æ€»è®¡[ï¼š:]\s*(\d+)/);
        const successMatch = text.match(/æˆåŠŸ[ï¼š:]\s*(\d+)/);
        const failMatch = text.match(/å¤±è´¥[ï¼š:]\s*(\d+)/);

        const success = successMatch ? successMatch[1] : "0";
        const fail = failMatch ? failMatch[1] : "0";
        const isAllSuccess = parseInt(fail) === 0 && parseInt(success) > 0;

        const coupons = [];
        const regex =
          /\*\*(.+?)\*\*[\s\S]*?couponCode[ï¼š:]\s*(\w+)[\s\S]*?<img src="([^"]+)"/g;
        let match;
        while ((match = regex.exec(text)) !== null) {
          coupons.push({ title: match[1], code: match[2], img: match[3] });
        }

        return `
                <div class="bind-result">
                    <div class="icon">${isAllSuccess ? "ğŸ‰" : parseInt(success) > 0 ? "âœ…" : "ğŸ˜¢"}</div>
                    <div class="bind-title">${isAllSuccess ? "é¢†åˆ¸æˆåŠŸ!" : parseInt(success) > 0 ? "éƒ¨åˆ†é¢†å–æˆåŠŸ" : "æš‚æ— å¯é¢†å–çš„åˆ¸"}</div>
                    <div class="bind-stats">
                        <div class="bind-stat"><div class="num success">${success}</div><div class="label">æˆåŠŸ</div></div>
                        <div class="bind-stat"><div class="num fail">${fail}</div><div class="label">å¤±è´¥</div></div>
                    </div>
                </div>
                ${
                  coupons.length
                    ? `<div class="coupons-grid">${coupons
                        .map(
                          (c) => `
                    <div class="coupon-card">
                        <img src="${c.img}" onerror="this.style.display='none'" alt="${c.title}">
                        <div class="info">
                            <div class="coupon-title">${c.title}</div>
                            <div class="validity" style="font-size:0.7rem;word-break:break-all">ğŸ« ${c.code}</div>
                        </div>
                    </div>
                `,
                        )
                        .join("")}</div>`
                    : ""
                }
            `;
      }

      function parseMarkdownCoupons(text) {
        const coupons = [];
        const regex =
          /ä¼˜æƒ åˆ¸æ ‡é¢˜[ï¼š:]\s*(.+?)[\s\n\\]+çŠ¶æ€[ï¼š:]\s*(.+?)[\s\n\\]+[\s\S]*?<img src="([^"]+)"/g;
        let match;
        while ((match = regex.exec(text)) !== null) {
          coupons.push({
            title: match[1].trim(),
            status: match[2].trim(),
            img: match[3],
          });
        }
        return coupons;
      }
    </script>
  </body>
</html>
